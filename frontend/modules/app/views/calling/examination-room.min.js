function setFullScreen(){var e=document.documentElement;$("body").hasClass("full-screen")?($("body").removeClass("full-screen"),$("#fullscreen-toggler").removeClass("active"),localStorage.setItem("medical-fullscreen","false"),document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()):($("body").addClass("full-screen"),$("#fullscreen-toggler").addClass("active"),localStorage.setItem("medical-fullscreen","true"),e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen())}function setTabletmode(){var e=$("div.panel-form"),t=$("div.panel-form").find("i:first"),a=e.find("div.panel-body"),n=e.find("div.panel-footer");if("true"==localStorage.getItem("examination-tablet-mode")){a.slideToggle(300),n.slideToggle(200),t.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down"),e.toggleClass("").toggleClass("panel-collapse"),setTimeout(function(){e.resize(),e.find("[id^=map-]").resize()},50);var s=$("#callingform-service_profile").select2("data")[0].text||"",l=[];$('#callingform-counter_service input[type="checkbox"]').each(function(e,t){var a=$(this);a.is(":checked")&&l.push(a.closest("label").text())}),$("div.panel-form .panel-heading-text").html(" | "+s+": "+l.join(" , ")),$("#tablet-mode").prop("checked",!0),$("#tab-menu-default,#tab-menu-default1,.small-header").css("display","none"),$(".footer-tabs,.call-next-tablet-mode,.text-tablet-mode").css("display",""),$("#tab-watting .panel-body,#tab-calling .panel-body,#tab-hold .panel-body").css("border-top","1px solid #e4e5e7")}else e.hasClass("panel-collapse")&&(a.slideToggle(300),n.slideToggle(200),t.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down"),e.toggleClass("").toggleClass("panel-collapse"),setTimeout(function(){e.resize(),e.find("[id^=map-]").resize()},50)),$("div.panel-form .panel-heading-text").html("&nbsp;"),$(".footer-tabs,.call-next-tablet-mode,.text-tablet-mode").css("display","none"),$("#tab-menu-default,#tab-menu-default1,.small-header").css("display",""),$("#tab-watting .panel-body,#tab-calling .panel-body,#tab-hold .panel-body").css("border-top","0")}$(function(){$("body").addClass("hide-sidebar"),$('input[type="search"]').focus(function(){$(this).animate({width:"250px"},400)}),$('input[type="search"]').blur(function(){$(this).animate({width:"160px"},500)}),$("#callingform-qnum").keyup(function(){this.value=this.value.toUpperCase()}),toastr.options={debug:!1,newestOnTop:!1,positionClass:"toast-top-center",closeButton:!0,toastClass:"animated fadeInDown"};var e=$(".i-checks").iCheck({checkboxClass:"icheckbox_flat-green",radioClass:"iradio_square-green"});$(e).on("ifChecked",function(e){var t=$(this).val();if(Queue.setDataSession(),!app.form.counter_service_ids.includes(parseInt(t))){var a=[];a.push(...app.form.counter_service_ids),a.push(parseInt(t)),app.setState({key:"counter_service_ids",value:a})}}),$(e).on("ifUnchecked",function(e){var t=$(this).val();if(app.form.counter_service_ids.includes(parseInt(t))){var a=[];a.push(...app.form.counter_service_ids),a=a.filter(e=>e!==parseInt(t)),app.setState({key:"counter_service_ids",value:a})}Queue.setDataSession()})}),Queue={setDataSession:function(){var e=$("#calling-form"),t=e.serialize();$.ajax({method:"POST",url:"/app/calling/set-counter-session",data:t,dataType:"json",beforeSend:function(e,t){swal({title:"Loading...",text:"",onOpen:()=>{swal.showLoading()}}).then(e=>{})},success:function(e){swal.close()},error:function(e,t,a){Queue.ajaxAlertError(a)}})},handleEventClick:function(){var e=this;$("#tb-waiting tbody").on("click","tr td a.btn-calling",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbwaiting.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key");var n=app.tbwaiting.row(a).data();swal({title:"ยืนยันเรียกคิว "+n.q_num+" ?",html:'<p><i class="fa fa-user"></i> '+n.pt_name+"</p>",input:"select",type:"question",inputOptions:app.counterOpts,inputPlaceholder:"เลือกห้องตรวจ",inputValue:n.counter_service_id||"",inputClass:"form-control m-b",showCancelButton:!0,confirmButtonText:"เรียกคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,inputValidator:e=>{if(!e)return"คุณไม่ได้เลือกห้องตรวจ!"},preConfirm:t=>new Promise(a=>{$.ajax({method:"POST",url:`/node/api/v1/calling/call?id=${n.q_ids}&access-token=${accesstoken}`,dataType:"json",data:{data:n,...app.form,counter_service_id:t},success:function(t){200==t.status?(e.reloadTbWaiting(),e.reloadTbCalling(),e.toastrSuccess("CALL "+n.q_num),socket.emit("call",t),a()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}),jQuery(".swal2-select").select2({allowClear:!0,theme:"bootstrap",width:"100%",placeholder:"เลือกห้องตรวจ...",language:"th",sorter:function(e){return e.sort(function(e,t){return e.text<t.text?-1:e.text>t.text?1:0})}}),$("select.swal2-select, span.select2").addClass("input-lg"),$("#swal2-content").css("padding-bottom","15px")}),$("#tb-calling tbody").on("click","tr td a.btn-recall",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbcalling.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key");var n=$(this).attr("href"),s=app.tbcalling.row(a).data();swal({title:"ยืนยันเรียกคิว "+s.q_num+" ?",text:s.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+s.pt_name+"</p>",type:"question",showCancelButton:!0,confirmButtonText:"เรียกคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,onOpen:()=>{swal.clickConfirm()},preConfirm:function(){return new Promise(function(t,a){$.ajax({method:"POST",url:`${n}&access-token=${accesstoken}`,dataType:"json",data:{data:s,...app.form,counter_service_id:s.counter_service_id},success:function(a){200==a.status?(app.tbcalling.ajax.reload(),e.toastrSuccess("RECALL "+s.q_num),socket.emit("call",a),t()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}}).then(e=>{e.value&&swal.close()})}),$("#tb-calling tbody").on("click","tr td a.btn-hold",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbcalling.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key");var n=$(this).attr("href"),s=app.tbcalling.row(a).data();swal({title:"ยืนยันพักคิว "+s.q_num+" ?",text:s.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+s.pt_name+"</p>",type:"question",showCancelButton:!0,confirmButtonText:"พักคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(t,a){$.ajax({method:"POST",url:`${n}&access-token=${accesstoken}`,dataType:"json",data:{data:s,...app.form,counter_service_id:s.counter_service_id},success:function(a){200==a.status?(e.reloadTbCalling(),e.reloadTbHold(),e.toastrSuccess("HOLD "+s.q_num),socket.emit("hold",a),t()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}}).then(e=>{e.value&&swal.close()})}),$("#tb-calling tbody").on("click","tr td a.btn-transfer",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbcalling.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key");var n=app.tbcalling.row(a).data();swal({title:"ส่งคิว "+n.q_num+" ?",text:n.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+n.pt_name+"</p>",input:"select",type:"question",inputOptions:select2Data,inputPlaceholder:"เลือกห้องตรวจ",inputValue:n.counter_service_id||"",inputClass:"form-control m-b",showCancelButton:!0,confirmButtonText:"ส่งคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,inputValidator:e=>{if(!e)return"คุณไม่ได้เลือกห้องตรวจ!"},preConfirm:function(t){return new Promise(function(a,s){$.ajax({method:"POST",url:"/app/calling/transfer-examination-room",dataType:"json",data:{data:n,modelForm:modelForm,modelProfile:modelProfile,value:t},success:function(t){200==t.status?(e.reloadTbCalling(),e.toastrSuccess("Transfer "+n.q_num),socket.emit("transfer-examination-room",t),a()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}}).then(e=>{e.value&&swal.close()}),jQuery(".swal2-select").select2({allowClear:!0,theme:"bootstrap",width:"100%",placeholder:"เลือกห้องตรวจ...",language:"th",sorter:function(e){return e.sort(function(e,t){return e.text<t.text?-1:e.text>t.text?1:0})}}),$("select.swal2-select, span.select2").addClass("input-lg"),$("#swal2-content").css("padding-bottom","15px")}),$("#tb-hold tbody").on("click","tr td a.btn-calling",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbhold.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key"),$(this).attr("href");var n=app.tbhold.row(a).data();swal({title:"ยืนยันเรียกคิว "+n.q_num+" ?",text:n.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+n.pt_name+"</p>",type:"question",showCancelButton:!0,confirmButtonText:"เรียกคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(t,a){$.ajax({method:"POST",url:`/node/api/v1/calling/recall?id=${n.caller_ids}&access-token=${accesstoken}`,dataType:"json",data:{data:n,...app.form,counter_service_id:n.counter_service_id},success:function(a){200==a.status?(e.reloadTbCalling(),e.reloadTbHold(),e.toastrSuccess("CALL "+n.q_num),socket.emit("call",a),t()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}}).then(e=>{e.value&&swal.close()})}),$("#tb-hold tbody").on("click","tr td a.btn-end",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbhold.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key");var n=$(this).attr("href"),s=app.tbhold.row(a).data();swal({title:"ยืนยัน End คิว "+s.q_num+" ?",text:s.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+s.pt_name+"</p>",type:"question",showCancelButton:!0,confirmButtonText:"ยืนยัน",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(t,a){$.ajax({method:"POST",url:`${n}&access-token=${accesstoken}`,dataType:"json",data:{data:s,...app.form,counter_service_id:s.counter_service_id},success:function(a){200==a.status?(e.reloadTbCalling(),e.reloadTbHold(),e.toastrSuccess("END "+s.q_num),socket.emit("finish",a),t()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}}).then(e=>{e.value&&swal.close()})}),$("#tb-hold tbody").on("click","tr td a.btn-transfer",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbhold.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key");var n=app.tbhold.row(a).data();swal({title:"ส่งคิว "+n.q_num+" ?",text:n.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+n.pt_name+"</p>",input:"select",type:"question",inputOptions:select2Data,inputPlaceholder:"เลือกห้องตรวจ",inputValue:n.counter_service_id||"",inputClass:"form-control m-b",showCancelButton:!0,confirmButtonText:"ส่งคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,inputValidator:e=>{if(!e)return"คุณไม่ได้เลือกห้องตรวจ!"},preConfirm:function(t){return new Promise(function(a,s){$.ajax({method:"POST",url:baseUrl+"/app/calling/transfer-examination-room",dataType:"json",data:{data:n,modelForm:modelForm,modelProfile:modelProfile,value:t},success:function(t){200==t.status?(e.reloadTbCalling(),e.reloadTbHold(),e.toastrSuccess("Transfer "+n.q_num),socket.emit("transfer-examination-room",t),a()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}}).then(e=>{e.value&&swal.close()}),jQuery(".swal2-select").select2({allowClear:!0,theme:"bootstrap",width:"100%",placeholder:"เลือกห้องตรวจ...",language:"th",sorter:function(e){return e.sort(function(e,t){return e.text<t.text?-1:e.text>t.text?1:0})}}),$("select.swal2-select, span.select2").addClass("input-lg"),$("#swal2-content").css("padding-bottom","15px")}),$("#tb-calling tbody").on("click","tr td a.btn-end",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbcalling.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key");var n=$(this).attr("href"),s=app.tbcalling.row(a).data();swal({title:"ยืนยัน End คิว "+s.q_num+" ?",text:s.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+s.pt_name+"</p>",type:"question",showCancelButton:!0,confirmButtonText:"ยืนยัน",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(t,a){$.ajax({method:"POST",url:`${n}&access-token=${accesstoken}`,dataType:"json",data:{data:s,...app.form,counter_service_id:s.counter_service_id},success:function(a){200==a.status?(e.reloadTbCalling(),e.toastrSuccess("END "+s.q_num),socket.emit("finish",a),t()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}}).then(e=>{e.value&&swal.close()})}),$("#tb-waiting tbody").on("click","tr td a.btn-end",function(t){t.preventDefault();var a=$(this).closest("tr");a.hasClass("child")&&void 0===app.tbwaiting.row(a).data()&&(a=$(this).closest("tr").prev());a.data("key");var n=app.tbwaiting.row(a).data();swal({title:"ยืนยัน End คิว "+n.q_num+" ?",text:n.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small>',input:"select",type:"question",inputOptions:app.counterOpts,inputPlaceholder:"เลือกห้องตรวจ",inputValue:n.counter_service_id||"",inputClass:"form-control m-b",showCancelButton:!0,confirmButtonText:"ยืนยัน",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,inputValidator:e=>{if(!e)return"คุณไม่ได้เลือกห้องตรวจ!"},preConfirm:t=>new Promise(a=>{$.ajax({method:"POST",url:`${url}&access-token=${accesstoken}`,dataType:"json",data:{data:n,...app.form,counter_service_id:t},success:function(t){200==t.status?(e.reloadTbWaiting(),e.toastrSuccess("END "+n.q_num),socket.emit("finish",t),a()):e.ajaxAlertWarning()},error:function(t,a,n){e.ajaxAlertError(n)}})})}),jQuery(".swal2-select").select2({allowClear:!0,theme:"bootstrap",width:"100%",placeholder:"เลือกห้องตรวจ...",language:"th",sorter:function(e){return e.sort(function(e,t){return e.text<t.text?-1:e.text>t.text?1:0})}}),$("select.swal2-select, span.select2").addClass("input-lg"),$("#swal2-content").css("padding-bottom","15px")})},init:function(){var e=this;e.handleEventClick()},reloadTbWaiting:function(){!app.waitingLoading&&app.tbwaiting&&app.tbwaiting.ajax.reload()},reloadTbCalling:function(){!app.callingLoading&&app.tbcalling&&app.tbcalling.ajax.reload()},reloadTbHold:function(){!app.holdLoading&&app.tbhold&&app.tbhold.ajax.reload()},toastrSuccess:function(e){"on"==localStorage.getItem("disablealert-pagecalling")&&toastr.success(e,"Success!",{timeOut:3e3,positionClass:"toast-top-right",progressBar:!0,closeButton:!0})},toastrWarning:function(e="Warning!",t=""){"on"==localStorage.getItem("disablealert-pagecalling")&&toastr.success(t,e,{timeOut:5e3,positionClass:"toast-top-right",progressBar:!0,closeButton:!0})},ajaxAlertError:function(e){swal({type:"error",title:e,showConfirmButton:!1,timer:1500})},ajaxAlertWarning:function(){swal({type:"error",title:"เกิดข้อผิดพลาด!!",showConfirmButton:!1,timer:1500})},checkCounter:function(){if(null==modelForm.service_profile){var e="กรุณาเลือกโปรไฟล์";return swal({type:"warning",title:e,showConfirmButton:!1,timer:1500}),!1}return!0}},$(function(){socket.on("finish",e=>{var t=String(_.get(app.modelServiceProfile,"service_id")).split(",");if(-1!=jQuery.inArray(e.modelQueue.serviceid.toString(),t)){if("on"==localStorage.getItem("playsound-pagecalling")){$("#jplayer_notify").jPlayer({ready:function(){$(this).jPlayer("setMedia",{mp3:"/media/alert.mp3"}).jPlayer("play")},supplied:"mp3",ended:function(){$(this).jPlayer("stop")}});$("#jplayer_notify").jPlayer("play")}Queue.reloadTbWaiting(),Queue.toastrWarning("ผู้ป่วยลงทะเบียนใหม่!",e.modelQueue.pt_name)}else Queue.reloadTbWaiting()}).on("call",e=>{if("tb-waiting"===e.eventOn&&"call"===e.state){Queue.reloadTbWaiting();var t=app.form.counter_service_ids;-1!=jQuery.inArray(e.counter.counterserviceid,t)&&Queue.reloadTbCalling(),swal.close()}else if("tb-hold"===e.eventOn&&"call-hold"===e.state){t=app.form.counter_service_ids;-1!=jQuery.inArray(e.counter.counterserviceid,t)&&(Queue.reloadTbCalling(),Queue.reloadTbHold())}}).on("hold",e=>{var t=modelForm.counter_service;-1!=jQuery.inArray(e.counter.counterserviceid.toString(),t)&&(Queue.reloadTbCalling(),Queue.reloadTbHold())}).on("transfer-examination-room",e=>{Queue.reloadTbCalling(),Queue.reloadTbHold()}).on("finish",e=>{var t=app.form.counter_service_ids;-1!=jQuery.inArray(e.counter.counterserviceid,t)&&Queue.reloadTbCalling()}).on("display",e=>{setTimeout(function(){app.tbcalling.rows().every(function(t,a,n){var s=this.data();s.q_ids===e.artist.modelQueue.q_ids&&($("#tb-calling").find("tr.success").removeClass("success"),$("#last-queue").html(s.q_num),app.tbcalling.$("tr#"+e.artist.data.DT_RowId).addClass("success"),Queue.toastrWarning("",'<i class="pe-7s-speaker"></i> กำลังเรียกคิว #'+s.q_num))})},500)})}),$("a.activity-callnext").on("click",function(e){e.preventDefault();var t=app.tbwaiting.rows(0).data();t.length>0?(swal({title:"ยืนยันเรียกคิว "+t[0].q_num+" ?",html:'<p><i class="fa fa-user"></i> '+t[0].pt_name+"</p>",input:"select",type:"question",inputOptions:app.counterOpts,inputPlaceholder:"เลือกห้องตรวจ",inputValue:t[0].counter_service_id||"",inputClass:"form-control m-b",showCancelButton:!0,confirmButtonText:"เรียกคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,inputValidator:e=>{if(!e)return"คุณไม่ได้เลือกห้องตรวจ!"},preConfirm:e=>new Promise(a=>{$.ajax({method:"POST",url:`/node/api/v1/calling/call?id=${t[0].q_ids}&access-token=${accesstoken}`,dataType:"json",data:{data:t[0],...app.form,counter_service_id:e},success:function(e){200==e.status?(Queue.reloadTbWaiting(),Queue.reloadTbCalling(),Queue.toastrSuccess("CALL "+t[0].q_num),socket.emit("call",e),a()):Queue.ajaxAlertWarning()},error:function(e,t,a){Queue.ajaxAlertError(a)}})})}),jQuery(".swal2-select").select2({allowClear:!0,theme:"bootstrap",width:"100%",placeholder:"เลือกห้องตรวจ...",language:"th"}),$("select.swal2-select, span.select2").addClass("input-lg"),$("#swal2-content").css("padding-bottom","15px")):swal({type:"warning",title:"ไม่พบหมายเลขคิว",showConfirmButton:!1,timer:1500})});var $form=$("#calling-form");$form.on("beforeSubmit",function(){var e,t={};return $form.serializeArray().map(function(e){t[e.name]=e.value}),null!=t["CallingForm[qnum]"]&&""!=t["CallingForm[qnum]"]?(app.tbcalling.rows().every(function(a,n,s){var l=this.data();l.q_num===t["CallingForm[qnum]"]&&(e={data:l,tbkey:"tbcalling"})}),app.tbwaiting.rows().every(function(a,n,s){var l=this.data();l.q_num===t["CallingForm[qnum]"]&&(e={data:l,tbkey:"tbwaiting"})}),app.tbhold.rows().every(function(a,n,s){var l=this.data();l.q_num===t["CallingForm[qnum]"]&&(e={data:l,tbkey:"tbhold"})}),void 0===e?toastr.error(t["CallingForm[qnum]"],"ไม่พบข้อมูล!",{timeOut:3e3,positionClass:"toast-top-right"}):"tbcalling"===e.tbkey?swal({title:"ยืนยันเรียกคิว "+e.data.q_num+" ?",text:e.data.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+e.data.pt_name+"</p>",type:"question",showCancelButton:!0,confirmButtonText:"เรียกคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(t,a){$.ajax({method:"POST",url:`/node/api/v1/calling/recall?id=${e.data.caller_ids}&access-token=${accesstoken}`,dataType:"json",data:{data:e.data,...app.form,counter_service_id:e.data.counter_service_id},success:function(a){200==a.status?(Queue.reloadTbCalling(),Queue.toastrSuccess("RECALL "+e.data.q_num),socket.emit("call",a),t()):Queue.ajaxAlertWarning()},error:function(e,t,a){Queue.ajaxAlertError(a)}})})}}).then(e=>{e.value&&swal.close()}):"tbhold"===e.tbkey?swal({title:"ยืนยันเรียกคิว "+e.data.q_num+" ?",text:e.data.pt_name,html:'<small class="text-danger" style="font-size: 13px;">กด Enter เพื่อยืนยัน / กด Esc เพื่อยกเลิก</small><p><i class="fa fa-user"></i>'+e.data.pt_name+"</p>",type:"question",showCancelButton:!0,confirmButtonText:"เรียกคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,preConfirm:function(){return new Promise(function(t,a){$.ajax({method:"POST",url:`/node/api/v1/calling/recall?id=${e.data.caller_ids}&access-token=${accesstoken}`,dataType:"json",data:{data:e.data,...app.form,counter_service_id:e.data.counter_service_id},success:function(a){200==a.status?(Queue.reloadTbCalling(),Queue.reloadTbHold(),Queue.toastrSuccess("CALL "+e.data.q_num),socket.emit("call",a),t()):Queue.ajaxAlertWarning()},error:function(e,t,a){Queue.ajaxAlertError(a)}})})}}).then(e=>{e.value&&swal.close()}):"tbwaiting"===e.tbkey&&(swal({title:"ยืนยันเรียกคิว "+e.data.q_num+" ?",html:'<p><i class="fa fa-user"></i> '+e.data.pt_name+"</p>",input:"select",type:"question",inputOptions:app.counterOpts,inputPlaceholder:"เลือกห้องตรวจ",inputValue:e.data.counter_service_id||"",inputClass:"form-control m-b",showCancelButton:!0,confirmButtonText:"เรียกคิว",cancelButtonText:"ยกเลิก",allowOutsideClick:!1,showLoaderOnConfirm:!0,inputValidator:e=>{if(!e)return"คุณไม่ได้เลือกห้องตรวจ!"},preConfirm:t=>new Promise(a=>{$.ajax({method:"POST",url:`/node/api/v1/calling/call?id=${e.data.q_ids}&access-token=${accesstoken}`,dataType:"json",data:{data:e.data,...app.form,counter_service_id:t},success:function(t){200==t.status?(Queue.reloadTbWaiting(),Queue.reloadTbCalling(),Queue.toastrSuccess("CALL "+e.data.q_num),socket.emit("call",t),a()):Queue.ajaxAlertWarning()},error:function(e,t,a){Queue.ajaxAlertError(a)}})})}),jQuery(".swal2-select").select2({allowClear:!0,theme:"bootstrap",width:"100%",placeholder:"เลือกห้องตรวจ...",language:"th"}),$("select.swal2-select, span.select2").addClass("input-lg"),$("#swal2-content").css("padding-bottom","15px"))):toastr.error(t["CallingForm[qnum]"],"ไม่พบข้อมูล!",{timeOut:3e3,positionClass:"toast-top-right"}),$("input#callingform-qnum").val(null),!1}),Queue.init(),$("#fullscreen-toggler").on("click",function(e){setFullScreen()}),$(document).ready(function(){$("#tablet-mode").on("click",function(){$(this).is(":checked")?localStorage.setItem("examination-tablet-mode","true"):localStorage.setItem("examination-tablet-mode","false"),setTabletmode()})}),setTabletmode(),$("#callingform-service_profile").on("change",function(){var e=$(this).val();app.setState({key:"service_profile_id",value:e}),app.fetchDataServiceProfile()}),Vue.use(Vuex);const{mapActions:mapActions,mapGetters:mapGetters}=Vuex,store=new Vuex.Store({state:{service_profile_id:null,counter_service_ids:[]},getters:{form:e=>({service_profile_id:e.service_profile_id,counter_service_ids:e.counter_service_ids})},mutations:{SET_STATE(e,{key:t,value:a}){e[t]=a}},actions:{setState({commit:e},t){e("SET_STATE",t)}},plugins:[createPersistedState({key:"vuex-examination"})]});var app=new Vue({el:"#app",store:store,data:{modelServiceProfile:null,counters:[],tbwaiting:null,tbcalling:null,tbhold:null,waitingLoading:!1,callingLoading:!1,holdLoading:!1},computed:{...mapGetters({form:"form"}),serviceids(){return String(_.get(this.modelServiceProfile,"service_id","")).split(",")},counterOpts(){const e={},t=this.counters.filter(e=>this.form.counter_service_ids.includes(parseInt(e.counterserviceid)));for(let a=0;a<t.length;a++){const n=t[a];e[n.counterserviceid]=n.counterservice_name}return e}},mounted(){this.$nextTick(function(){var e=[];$.each($("input[name='CallingForm[counter_service][]']:checked"),function(){var t=$(this).val();e.push(parseInt(t))}),app.setState({key:"counter_service_ids",value:e}),$("#callingform-service_profile").val()&&(this.setState({key:"service_profile_id",value:$("#callingform-service_profile").val()}),this.fetchDataServiceProfile())})},methods:{...mapActions({setState:"setState"}),fetchDataServiceProfile:function(){const e=this;$.ajax({method:"GET",url:"/app/calling/service-profile",dataType:"json",data:{id:e.form.service_profile_id},success:async function(t){e.modelServiceProfile=t,await e.fetchDataCounterservices(),e.initTableWaiting(),e.initTableCalling(),e.initTableHold()},error:function(e,t,a){Queue.ajaxAlertError(a)}})},fetchDataCounterservices:function(){const e=this;$.ajax({method:"GET",url:"/app/calling/counter-services",dataType:"json",data:{counterservice_typeid:_.get(e.modelServiceProfile,"counterservice_typeid")},success:function(t){e.counters=t},error:function(e,t,a){Queue.ajaxAlertError(a)}})},initTableWaiting:function(){const e=this;e.tbwaiting&&e.tbwaiting.destroy();var t=jQuery("#tb-waiting").DataTable({ajax:{url:"/node/api/v1/examination/waiting-list",data:function(t,a){var n=new $.fn.dataTable.Api(a),s=n.page.info(),l={number:s.page+1,size:s.length};return-1!==s.length?$.extend({},t,{page:l,filter:{service_id:{in:e.serviceids},service_status_id:5},form:e.form,"access-token":accesstoken}):$.extend({},t,{form:e.form,filter:{service_id:{in:e.serviceids},service_status_id:5},"access-token":accesstoken})},type:"GET"},dom:"<'row'<'col-xs-6'f><'col-xs-6 d-flex justify-content-end'Bl>> <'row'<'col-xs-12'tr>> <'row'<'col-xs-5'i><'col-xs-7'p>>",language:{loadingRecords:"กำลังดำเนินการ...",zeroRecords:"",lengthMenu:"_MENU_",info:"แสดง _START_ ถึง _END_ จาก _TOTAL_ แถว",infoEmpty:"แสดง 0 ถึง 0 จาก 0 แถว",infoFiltered:"(กรองข้อมูล _MAX_ ทุกแถว)",emptyTable:"ไม่พบข้อมูล",oPaginate:{sFirst:"หน้าแรก",sPrevious:"ก่อนหน้า",sNext:"ถัดไป",sLast:"หน้าสุดท้าย"},search:"_INPUT_ ",searchPlaceholder:"ค้นหา..."},pageLength:10,lengthMenu:[[10,25,50,75,100,-1],[10,25,50,75,100,"All"]],autoWidth:!1,deferRender:!0,searchHighlight:!0,responsive:!1,processing:!0,serverSide:!0,initComplete:function(){var e=this.api();dtFnc.initResponsive(e),dtFnc.initColumnIndex(e)},columns:[{data:null,defaultContent:"",className:"dt-center dt-head-nowrap",title:"#",orderable:!1},{data:"q_num",className:"dt-body-center dt-head-nowrap",title:'<i class="fa fa-money"></i> คิว',render:function(e,t,a,n){return`<span class="badge badge-success">${a.q_num}</span>`}},{data:"q_hn",className:"dt-body-center dt-head-nowrap",title:"HN"},{data:"q_qn",className:"dt-body-center dt-head-nowrap",title:"QN"},{data:"service_name",className:"dt-body-left dt-head-nowrap",title:"ประเภท"},{data:"pt_name",className:"dt-body-left dt-head-nowrap",title:'<i class="fa fa-user"></i> ชื่อ-นามสกุล'},{data:"checkin_date",className:"dt-body-center dt-head-nowrap",title:'<i class="fa fa-clock-o"></i> เวลามาถึง',visible:!1},{data:"counterservice_name",className:"dt-body-center dt-head-nowrap",title:"จุดบริการ",visible:!1},{data:"service_status_name",className:"dt-body-center dt-head-nowrap",title:"สถานะ"},{data:"service_prefix",className:"dt-body-center dt-head-nowrap",title:"prefix",visible:!1},{data:null,defaultContent:"",className:"dt-center dt-nowrap",orderable:!1,title:'<i class="fa fa-cogs"></i> ดำเนินการ',responsivePriority:1,render:function(e,t,a,n){return`<a href="/node/api/v1/calling/call?id=${a.q_ids}" class="btn btn-success btn-calling">เรียกคิว</a>\n            <a href="/node/api/v1/calling/end?id=${a.q_ids}" class="btn btn-danger btn-end">เสร็จสิ้น</a>`}}],columnDefs:[{targets:[2,3,4,6,7,8,9],visible:!1}],buttons:[{extend:"colvis",text:'<i class="glyphicon glyphicon-list"></i> '},{text:'<i class="glyphicon glyphicon-refresh"></i> ',action:function(e,t,a,n){t.ajax.reload()}}],drawCallback:function(e){var t=this.api(),a=t.data().count();$(".count-waiting").html(a)}});jQuery("#tb-waiting").on("error.dt",function(e,t,a,n){e.preventDefault(),swal({title:"Error...!",html:"<small>"+n+"</small>",type:"error"})}).on("preXhr.dt",function(t,a,n){e.waitingLoading=!0}).on("xhr.dt",function(t,a,n,s){$(".count-waiting").html(n.total||0),e.waitingLoading=!1}),this.tbwaiting=t},initTableCalling:function(){const e=this;e.tbcalling&&e.tbcalling.destroy();var t=jQuery("#tb-calling").DataTable({ajax:{url:"/node/api/v1/examination/calling-list",data:function(t,a){var n=new $.fn.dataTable.Api(a),s=n.page.info(),l={number:s.page+1,size:s.length};return-1!==s.length?$.extend({},t,{page:l,filter:{service_id:{in:e.serviceids},counter_service_id:{in:e.form.counter_service_ids},service_status_id:2},form:e.form,"access-token":accesstoken}):$.extend({},t,{form:e.form,filter:{service_id:{in:e.serviceids},service_status_id:5},"access-token":accesstoken})},type:"GET"},dom:"<'row'<'col-xs-6'f><'col-xs-6 d-flex justify-content-end'Bl>> <'row'<'col-xs-12'tr>> <'row'<'col-xs-5'i><'col-xs-7'p>>",language:{loadingRecords:"กำลังดำเนินการ...",zeroRecords:"",lengthMenu:"_MENU_",info:"แสดง _START_ ถึง _END_ จาก _TOTAL_ แถว",infoEmpty:"แสดง 0 ถึง 0 จาก 0 แถว",infoFiltered:"(กรองข้อมูล _MAX_ ทุกแถว)",emptyTable:"ไม่พบข้อมูล",oPaginate:{sFirst:"หน้าแรก",sPrevious:"ก่อนหน้า",sNext:"ถัดไป",sLast:"หน้าสุดท้าย"},search:"_INPUT_ ",searchPlaceholder:"ค้นหา..."},pageLength:10,lengthMenu:[[10,25,50,75,100,-1],[10,25,50,75,100,"All"]],autoWidth:!1,deferRender:!0,searchHighlight:!0,responsive:!1,processing:!0,serverSide:!0,order:[[9,"asc"]],drawCallback:function(e){var t=this.api();dtFnc.initConfirm(t);var a=t.data().count();$(".count-calling").html(a);var n=t.rows({page:"current"}).nodes(),s=t.columns().nodes(),l=null;t.column(3,{page:"current"}).data().each(function(e,a){t.rows(a).data();l!==e&&($(n).eq(a).before('<tr class=""><td style="text-align: left;font-size: 16px;" colspan="'+s.length+'">'+e+"</td></tr>"),l=e)})},initComplete:function(){var e=this.api();dtFnc.initResponsive(e),dtFnc.initColumnIndex(e)},columns:[{data:null,defaultContent:"",className:"dt-center dt-head-nowrap",title:"#",orderable:!1},{data:"q_num",className:"dt-body-center dt-head-nowrap",title:'<i class="fa fa-money"></i> คิว',render:function(e,t,a,n){return`<span class="badge badge-success">${a.q_num}</span>`}},{data:"q_hn",className:"dt-body-center dt-head-nowrap",title:"HN"},{data:"q_qn",className:"dt-body-center dt-head-nowrap",title:"QN"},{data:"service_name",className:"dt-body-left dt-head-nowrap",title:"ประเภท"},{data:"pt_name",className:"dt-body-left dt-head-nowrap",title:'<i class="fa fa-user"></i> ชื่อ-นามสกุล'},{data:"counterservice_name",className:"dt-body-center dt-head-nowrap",title:"จุดบริการ"},{data:"checkin_date",className:"dt-body-center dt-head-nowrap",title:'<i class="fa fa-clock-o"></i> เวลามาถึง'},{data:"service_status_name",className:"dt-body-center dt-head-nowrap",title:"สถานะ"},{data:"service_prefix",className:"dt-body-center dt-head-nowrap",title:"prefix"},{data:null,defaultContent:"",className:"dt-center dt-nowrap",orderable:!1,title:'<i class="fa fa-cogs"></i> ดำเนินการ',responsivePriority:1,render:function(e,t,a,n){return`<a href="/node/api/v1/calling/recall?id=${a.caller_ids}" class="btn btn-success btn-recall">เรียกคิว</a>\n              <a href="/node/api/v1/calling/hold?id=${a.caller_ids}" class="btn btn-warning btn-hold">พักคิว</a>\n              <a href="/node/api/v1/calling/end?id=${a.caller_ids}" class="btn btn-danger btn-end">เสร็จสิ้น</a>`}}],columnDefs:[{targets:[2,3,6,7,8,9],visible:!1}],buttons:[{extend:"colvis",text:'<i class="glyphicon glyphicon-list"></i> '},{text:'<i class="glyphicon glyphicon-refresh"></i> ',action:function(e,t,a,n){t.ajax.reload()}}]})
;jQuery("#tb-calling").on("error.dt",function(e,t,a,n){e.preventDefault(),swal({title:"Error...!",html:"<small>"+n+"</small>",type:"error"})}).on("preXhr.dt",function(t,a,n){e.callingLoading=!0}).on("xhr.dt",function(t,a,n,s){$(".count-calling").html(n.total||0),e.callingLoading=!1}),e.tbcalling=t},initTableHold:function(){const e=this;e.tbhold&&e.tbhold.destroy();var t=jQuery("#tb-hold").DataTable({ajax:{url:"/node/api/v1/examination/hold-list",data:function(t,a){var n=new $.fn.dataTable.Api(a),s=n.page.info(),l={number:s.page+1,size:s.length};return-1!==s.length?$.extend({},t,{page:l,filter:{service_id:{in:e.serviceids},counter_service_id:{in:e.form.counter_service_ids},service_status_id:3},form:e.form,"access-token":accesstoken}):$.extend({},t,{form:e.form,filter:{service_id:{in:e.serviceids},service_status_id:5},"access-token":accesstoken})},type:"GET"},dom:"<'row'<'col-xs-6'f><'col-xs-6 d-flex justify-content-end'Bl>> <'row'<'col-xs-12'tr>> <'row'<'col-xs-5'i><'col-xs-7'p>>",language:{loadingRecords:"กำลังดำเนินการ...",zeroRecords:"",lengthMenu:"_MENU_",info:"แสดง _START_ ถึง _END_ จาก _TOTAL_ แถว",infoEmpty:"แสดง 0 ถึง 0 จาก 0 แถว",infoFiltered:"(กรองข้อมูล _MAX_ ทุกแถว)",emptyTable:"ไม่พบข้อมูล",oPaginate:{sFirst:"หน้าแรก",sPrevious:"ก่อนหน้า",sNext:"ถัดไป",sLast:"หน้าสุดท้าย"},search:"_INPUT_ ",searchPlaceholder:"ค้นหา..."},pageLength:10,lengthMenu:[[10,25,50,75,100,-1],[10,25,50,75,100,"All"]],autoWidth:!1,deferRender:!0,searchHighlight:!0,responsive:!1,processing:!0,serverSide:!0,order:[[9,"asc"]],drawCallback:function(e){var t=this.api();dtFnc.initConfirm(t);var a=t.data().count();$(".count-hold").html(a);var n=t.rows({page:"current"}).nodes(),s=t.columns().nodes(),l=null;t.column(3,{page:"current"}).data().each(function(e,a){t.rows(a).data();l!==e&&($(n).eq(a).before('<tr class=""><td style="text-align: center;font-size: 16px;" colspan="'+s.length+'">'+e+"</td></tr>"),l=e)})},initComplete:function(){var e=this.api();dtFnc.initResponsive(e),dtFnc.initColumnIndex(e)},columns:[{data:null,defaultContent:"",className:"dt-center dt-head-nowrap",title:"#",orderable:!1},{data:"q_num",className:"dt-body-center dt-head-nowrap",title:'<i class="fa fa-money"></i> คิว',render:function(e,t,a,n){return`<span class="badge badge-success">${a.q_num}</span>`}},{data:"q_hn",className:"dt-body-center dt-head-nowrap",title:"HN"},{data:"q_qn",className:"dt-body-center dt-head-nowrap",title:"QN"},{data:"service_name",className:"dt-body-left dt-head-nowrap",title:"ประเภท"},{data:"pt_name",className:"dt-body-left dt-head-nowrap",title:'<i class="fa fa-user"></i> ชื่อ-นามสกุล'},{data:"counterservice_name",className:"dt-body-center dt-head-nowrap",title:"จุดบริการ"},{data:"checkin_date",className:"dt-body-center dt-head-nowrap",title:'<i class="fa fa-clock-o"></i> เวลามาถึง'},{data:"service_status_name",className:"dt-body-center dt-head-nowrap",title:"สถานะ"},{data:"service_prefix",className:"dt-body-center dt-head-nowrap",title:"prefix"},{data:null,defaultContent:"",className:"dt-center dt-nowrap",orderable:!1,title:'<i class="fa fa-cogs"></i> ดำเนินการ',render:function(e,t,a,n){return`<a href="/node/api/v1/calling/recall?id=${a.caller_ids}" class="btn btn-success btn-calling">เรียกคิว</a>\n              <a href="/node/api/v1/calling/end?id=${a.caller_ids}" class="btn btn-danger btn-end">เสร็จสิ้น</a>`}}],columnDefs:[{targets:[2,3,6,7,8,9],visible:!1}],buttons:[{extend:"colvis",text:'<i class="glyphicon glyphicon-list"></i> '},{text:'<i class="glyphicon glyphicon-refresh"></i> ',action:function(e,t,a,n){t.ajax.reload()}}]});jQuery("#tb-hold").on("error.dt",function(e,t,a,n){e.preventDefault(),swal({title:"Error...!",html:"<small>"+n+"</small>",type:"error"})}).on("preXhr.dt",function(t,a,n){e.holdLoading=!0}).on("xhr.dt",function(t,a,n,s){$(".count-hold").html(n.total||0),e.holdLoading=!1}),e.tbhold=t}}});